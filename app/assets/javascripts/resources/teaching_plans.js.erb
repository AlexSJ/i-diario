$(function () {
  window.classrooms = [];
  window.disciplines = [];

  var fetchClassrooms = function (params, callback) {
    if (_.isEmpty(window.classrooms)) {
      $.getJSON('/turmas?' + $.param(params)).always(function (data) {
        window.classrooms = data;
        callback(window.classrooms);
      });
    } else {
      callback(window.classrooms);
    }
  };

  var fetchDisciplines = function (params, callback) {
    if (_.isEmpty(window.disciplines)) {
      $.getJSON('/disciplinas?' + $.param(params)).always(function (data) {
        window.disciplines = data;
        callback(window.disciplines);
      });
    } else {
      callback(window.disciplines);
    }
  };

  $('#teaching_plan_unity_id').on('change', function (e) {
    var $classroom = $('#teaching_plan_classroom_id');
    var params = { unity_id: e.val };

    window.classrooms = [];

    $classroom.val('');
    $classroom.select2({ data: [] });

    if (!_.isEmpty(e.val)) {
      fetchClassrooms(params, function(classrooms) {
        var selectedClassrooms = _.map(classrooms, function (classroom) {
          return { id:classroom['id'], text: classroom['description'] };
        });

        $classroom.select2({
          data: selectedClassrooms
        });
      });
    }
  });

  $('#teaching_plan_classroom_id').on('change', function (e) {
    var $discipline = $('#teaching_plan_discipline_id');
    var params = { classroom_id: e.val };

    window.disciplines = [];

    $discipline.val('');
    $discipline.select2({ data: [] });

    if (!_.isEmpty(e.val)) {
      fetchDisciplines(params, function (disciplines) {
        var selectedDisciplines = _.map(disciplines, function (discipline) {
          return { id:discipline['id'], text: discipline['description'] };
        });

        $discipline.select2({
          data: selectedDisciplines
        });
      });
    }
  });

  $('#teaching_plan_school_term_type').on('change', function(e) {
    updateSchoolTermInput();
  });

  var updateSchoolTermInput = function() {
    var $school_term_div = $('#school_term');
    var $school_term_input = $('#teaching_plan_school_term');

    switch ($('#teaching_plan_school_term_type').select2('val')) {
      case 'bimester':
        $school_term_input.select2('val', '');
        $school_term_input.select2({ data: <%= Bimesters.to_select.to_json %> });
        $school_term_div.show();
        break;
      case 'trimester':
        $school_term_input.select2('val', '');
        $school_term_input.select2({ data: <%= Trimesters.to_select.to_json %> });
        $school_term_div.show();
        break;
      case 'semester':
        $school_term_input.select2('val', '');
        $school_term_input.select2({ data: <%= Semesters.to_select.to_json %> });
        $school_term_div.show();
        break;
      default:
        $school_term_div.hide();
        $school_term_input.select2('val', '');
        $school_term_input.select2({ data: [] });
        break;
    }
  }

  updateSchoolTermInput();
});
